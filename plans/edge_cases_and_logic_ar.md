# الحالات الاستثنائية ومنطق العمل (Edge Cases & Business Logic)

يستعرض هذا الملف السيناريوهات المعقدة التي قد تؤدي إلى خلل في تجربة المستخدم أو منطق النظام، وكيفية معالجتها برمجياً بناءً على وثيقة متطلبات المنتج (PRD).

---

## 1. استرداد الرصيد عند رفض الإدارة (Refund on Admin Rejection)
*   **السيناريو:** مستخدم دفع 1 رصيد لجعل فكرته "مفتوحة"، لكن المدير قام بـ **رفض** الفكرة بسبب مخالفة الشروط.
*   **المشكلة:** الرصيد خُصم بالفعل لكن الفكرة لم تُنشر.
*   **الحل:** يجب ربط عملية الرفض (Rejection) في لوحة الإدارة بإجراء تلقائي يعيد 1 رصيد لحساب المستخدم إذا كانت حالة الرؤية `OPEN`.

## 2. تغيير حالة الرؤية لاحقاً (Late Visibility Toggle)
*   **السيناريو:** مستخدم أنشأ فكرة بحالة "مغلقة"، وبعد أسبوع قرر جعلها "مفتوحة" لزيادة التفاعل.
*   **المشكلة:** كيف يتم التعامل مع الخصم في نموذج التعديل؟
*   **الحل:** يجب أن يعامل نموذج التعديل حقل الرؤية كعملية دفع. إذا تغيرت الحالة من `CLOSED` إلى `OPEN` يتم التحقق من الرصيد وخصمه فوراً.

## 3. انتهاء الاشتراك وفكرة "مفتوحة" (Subscription Expiration)
*   **السيناريو:** مستخدم دفع رصيداً لجعل فكرته مفتوحة، ثم انتهى اشتراكه في اليوم التالي.
*   **المشكلة:** هل تتحول الفكرة إلى "مغلقة" تلقائياً أم تبقى "مفتوحة"؟
*   **الحل:** 
    *   **المنطق المقترح:** بما أن المستخدم "اشترى" الرؤية بخصم رصيد، يجب أن تبقى الفكرة **مفتوحة** حتى لو انتهى اشتراكه، لأن العملية كانت "شراء خدمة لمرة واحدة" لتلك الفكرة تحديداً.

## 4. نفاذ الرصيد أثناء الإضافة (Zero Credits Mid-Creation)
*   **السيناريو:** مستخدم باقته مدفوعة لكن رصيده الحالي **0**، ويريد إضافة فكرة جديدة بحالة "مفتوحة".
*   **المشكلة:** الخيار متاح له لأنه مشترك، لكن الرصيد غير كافٍ.
*   **الحل:** يجب إظهار خيار "ادفع 9$ لجعل هذه الفكرة مفتوحة" داخل نموذج الإضافة، أو منعه من اختيار "مفتوح" حتى يتوفر رصيد أو يشتري رصيداً إضافياً.

## 5. تحديث البيانات بعد الفتح (Data Update After Unlock)
*   **السيناريو:** مستخدم (أ) فتح بيانات المستخدم (ب) مقابل 1 رصيد. بعد ذلك، قام المستخدم (ب) بتغيير رقم هاتفه.
*   **المشكلة:** هل يرى المستخدم (أ) البيانات القديمة أم الجديدة؟
*   **الحل:** عملية الفتح (Unlock) تفتح العلاقة بين المستخدم والفكرة. بمجرد الفتح، يرى المستخدم (أ) دائماً البيانات **اللحظية والحالية** للمستخدم (ب)، مهما قام الأخير بتحديثها.

## 6. دخول المسؤولين والإحصائيات (Admin/Ghost Unlocks)
*   **السيناريو:** المدير (Admin) يدخل لمشاهدة بيانات فكرة "مغلقة" لمراجعتها.
*   **المشكلة:** لا نريد أن يُحسب دخول المدير ضمن "إحصائيات الفتح" أو يخصم رصيداً من المدير.
*   **الحل:** يجب تعديل منطق الإحصائيات بحيث يتجاهل أي عمليات فتح يقوم بها مستخدم برتبة `admin`.

## 7. التغيير من "مفتوح" إلى "مغلق" (Switching Open to Closed)
*   **السيناريو:** مستخدم جعل فكرته "مفتوحة" (خصم 1 رصيد)، ثم غير رأيه وأراد جعلها "مغلقة".
*   **المشكلة:** هل يسترد الرصيد؟
*   **الحل:** لا يتم استرداد الرصيد. يجب إظهار رسالة تحذيرية: *"تحويل الفكرة إلى مغلقة لن يعيد لك الرصيد المخصوم، هل أنت متأكد؟"*

---

**تطبيق هذه القواعد يضمن عدالة النظام وحماية حقوق المستخدمين والمنصة.**
